<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Stats</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>body { background: #f4f7fa; }</style>
</head>
<body class="bg-gray-50 min-vh-100">
    <div class="container-fluid px-2 px-md-4 py-4 py-md-5 d-flex flex-column align-items-center justify-content-center w-100">
        <!-- Universal Reader Banner with Back Button -->
        <div class="w-full bg-[#23004c] py-6 shadow-lg mb-8">
            <div class="max-w-6xl mx-auto flex flex-row items-center justify-between">
                <div class="flex flex-col items-start">
                    <span class="text-4xl font-extrabold text-white tracking-wide drop-shadow-lg">Universal Reader</span>
                    <span class="text-lg text-indigo-100 mt-2 font-medium tracking-wider">Admin Dashboard</span>
                </div>
                <a href="/dashboard" class="inline-block px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 font-semibold transition ml-8">&larr; Back to Dashboard</a>
            </div>
        </div>

        <div class="max-w-6xl mx-auto py-8 px-4">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Statistics & Analytics</h1>

            <!-- Advanced Filters -->
            <div class="bg-white rounded-xl shadow p-5 mb-6 flex flex-col md:flex-row md:items-center md:space-x-6 space-y-2 md:space-y-0">
                <div>
                    <label class="block text-xs font-semibold text-gray-600">Extension</label>
                    <select id="filter-ext" class="border rounded px-2 py-1">
                        <option value="">All</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-600">Type</label>
                    <select id="filter-type" class="border rounded px-2 py-1">
                        <option value="">All</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-600">Risk</label>
                    <select id="filter-risk" class="border rounded px-2 py-1">
                        <option value="">All</option>
                        <option value="safe">Safe</option>
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-600">Score â‰¥</label>
                    <input id="filter-score" type="number" min="0" max="100" class="border rounded px-2 py-1 w-20" placeholder="0">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-600">Date</label>
                    <input id="filter-date" type="date" class="border rounded px-2 py-1">
                </div>
                <button onclick="applyFilters()" class="px-4 py-2 bg-purple-600 text-white rounded-lg shadow hover:bg-purple-700 font-semibold transition mt-2 md:mt-0">Apply Filters</button>
                <button onclick="resetFilters()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg shadow hover:bg-gray-300 font-semibold transition mt-2 md:mt-0">Reset</button>
            </div>

            <!-- Tabs -->
            <div class="flex space-x-2 justify-center mb-6">
                <button class="tab-btn px-4 py-2 rounded-t-lg font-medium text-gray-600 bg-white hover:bg-blue-100 focus:bg-blue-200 transition" onclick="showTab('overview')">Overview</button>
                <button class="tab-btn px-4 py-2 rounded-t-lg font-medium text-gray-600 bg-white hover:bg-green-100 focus:bg-green-200 transition" onclick="showTab('evolution')">Score Evolution</button>
                <button class="tab-btn px-4 py-2 rounded-t-lg font-medium text-gray-600 bg-white hover:bg-yellow-100 focus:bg-yellow-200 transition" onclick="showTab('risk')">Risk Distribution</button>
                <button class="tab-btn px-4 py-2 rounded-t-lg font-medium text-gray-600 bg-white hover:bg-pink-100 focus:bg-pink-200 transition" onclick="showTab('byext')">By Extension</button>
                <button class="tab-btn px-4 py-2 rounded-t-lg font-medium text-gray-600 bg-white hover:bg-purple-100 focus:bg-purple-200 transition" onclick="showTab('details')">Detailed Table</button>
                <button class="tab-btn px-4 py-2 rounded-t-lg font-medium text-gray-600 bg-white hover:bg-indigo-100 focus:bg-indigo-200 transition" onclick="showTab('bytype')">By Type</button>
            </div>

            <!-- Tab Panes -->
            <div id="overview" class="tab-pane">
                <h2 class="font-semibold text-2xl text-center mb-6 text-blue-800">Overview</h2>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
                    <div class="bg-white rounded-xl shadow p-5 text-center">
                        <div class="text-2xl font-bold text-blue-600" id="stat-total">0</div>
                        <div class="text-gray-600">Total Files</div>
                    </div>
                    <div class="bg-white rounded-xl shadow p-5 text-center">
                        <div class="text-2xl font-bold text-green-600" id="stat-safe">0</div>
                        <div class="text-gray-600">Safe Files</div>
                    </div>
                    <div class="bg-white rounded-xl shadow p-5 text-center">
                        <div class="text-2xl font-bold text-yellow-600" id="stat-low">0</div>
                        <div class="text-gray-600">Low Risk</div>
                    </div>
                    <div class="bg-white rounded-xl shadow p-5 text-center">
                        <div class="text-2xl font-bold text-orange-500" id="stat-medium">0</div>
                        <div class="text-gray-600">Medium Risk</div>
                    </div>
                    <div class="bg-white rounded-xl shadow p-5 text-center">
                        <div class="text-2xl font-bold text-red-600" id="stat-high">0</div>
                        <div class="text-gray-600">High Risk</div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow p-5 mb-8">
                    <h2 class="font-semibold text-lg mb-2">Average Score</h2>
                    <div class="text-3xl text-center font-bold text-purple-700" id="stat-average">0</div>
                </div>
            </div>
            <div id="evolution" class="tab-pane hidden">
                <h2 class="font-semibold text-2xl text-center mb-4 text-green-700">Score Evolution Over Time</h2>
                <canvas id="scoreEvolutionChart" height="120"></canvas>
            </div>
            <div id="risk" class="tab-pane hidden">
                <h2 class="font-semibold text-2xl text-center mb-4 text-yellow-700">Risk Distribution Over Time</h2>
                <canvas id="riskDistributionChart" height="120"></canvas>
            </div>
            <div id="details" class="tab-pane hidden">
                <h2 class="font-semibold text-2xl text-center mb-4 text-purple-700">Detailed File Table</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-xl shadow">
                        <thead>
                            <tr>
                                <th class="py-2 px-4 border-b">File</th>
                                <th class="py-2 px-4 border-b">Extension</th>
                                <th class="py-2 px-4 border-b">Score</th>
                                <th class="py-2 px-4 border-b">Status</th>
                                <th class="py-2 px-4 border-b">Date</th>
                                <th class="py-2 px-4 border-b">Risk</th>
                            </tr>
                        </thead>
                        <tbody id="detailsTableBody"></tbody>
                    </table>
                </div>
            </div>
            <div id="byext" class="tab-pane hidden">
                <h2 class="font-semibold text-2xl text-center mb-4 text-pink-700">Stats by Extension</h2>
                <canvas id="byExtChart" height="120"></canvas>
                <div class="overflow-x-auto mt-6">
                    <table class="min-w-full bg-white rounded-xl shadow">
                        <thead>
                            <tr><th class="py-2 px-4 border-b">Extension</th><th class="py-2 px-4 border-b">Count</th></tr>
                        </thead>
                        <tbody id="byExtTableBody"></tbody>
                    </table>
                </div>
            </div>
            <div id="bytype" class="tab-pane hidden">
                <h2 class="font-semibold text-2xl text-center mb-4 text-indigo-700">Stats by Type</h2>
                <canvas id="byTypeChart" height="120"></canvas>
                <div class="overflow-x-auto mt-6">
                    <table class="min-w-full bg-white rounded-xl shadow">
                        <thead>
                            <tr><th class="py-2 px-4 border-b">Count</th></tr>
                        </thead>
                        <tbody id="byTypeTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Dump JSON safely for the JS below -->
        <script id="stats-json" type="application/json">
            {{ stats_json|safe }}
        </script>

        <script>
        // Parse the injected JSON
        const statsData = JSON.parse(
            document.getElementById('stats-json').textContent
        );

        // Chart instances
        let scoreEvolutionChart = null;
        let riskDistributionChart = null;
        let byExtChart = null;
        let byTypeChart = null;

        function computeFilteredStats(files) {
            let safe = 0, low = 0, medium = 0, high = 0, sum = 0;
            let evolution = {}, risk = {};
            let ext_counts = {}, type_counts = {};

            files.forEach(f => {
                sum += f.score;
                if      (f.risk === 'safe')   safe++;
                else if (f.risk === 'low')    low++;
                else if (f.risk === 'medium') medium++;
                else if (f.risk === 'high')   high++;

                // Evolution
                evolution[f.date] = evolution[f.date] || [];
                evolution[f.date].push(f.score);

                // Risk by date
                risk[f.date] = risk[f.date] || { safe:0, low:0, medium:0, high:0 };
                risk[f.date][f.risk]++;

                // Counts
                ext_counts[f.ext]   = (ext_counts[f.ext]   || 0) + 1;
                type_counts[f.type] = (type_counts[f.type] || 0) + 1;
            });

            const dates = Object.keys(evolution).sort();
            const evolution_avgs = dates.map(d => {
                const arr = evolution[d];
                return arr.reduce((a,b)=>a+b,0) / arr.length;
            });

            const risk_dates = Object.keys(risk).sort();
            const risk_safe   = risk_dates.map(d=>risk[d].safe);
            const risk_low    = risk_dates.map(d=>risk[d].low);
            const risk_med    = risk_dates.map(d=>risk[d].medium);
            const risk_high   = risk_dates.map(d=>risk[d].high);

            return {
                total: files.length,
                safe, low, medium, high,
                average: files.length ? sum/files.length : 0,
                evolution: { dates, averages: evolution_avgs },
                risk:      { dates: risk_dates, safe: risk_safe, low: risk_low, medium: risk_med, high: risk_high },
                ext_counts,
                type_counts
            };
        }

        function updateAllStats(filteredFiles) {
            const stats = computeFilteredStats(filteredFiles);

            // Overview
            document.getElementById('stat-total').textContent   = stats.total;
            document.getElementById('stat-safe').textContent    = stats.safe;
            document.getElementById('stat-low').textContent     = stats.low;
            document.getElementById('stat-medium').textContent  = stats.medium;
            document.getElementById('stat-high').textContent    = stats.high;
            document.getElementById('stat-average').textContent = stats.average.toFixed(2);

            // Details table
            const tbody = document.getElementById('detailsTableBody');
            tbody.innerHTML = '';
            filteredFiles.forEach(f => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="py-2 px-4 border-b">${f.file}</td>
                    <td class="py-2 px-4 border-b">${f.ext}</td>
                    <td class="py-2 px-4 border-b">${f.score}</td>
                    <td class="py-2 px-4 border-b">${f.status}</td>
                    <td class="py-2 px-4 border-b">${f.date}</td>
                    <td class="py-2 px-4 border-b">${f.risk}</td>
                `;
                tbody.appendChild(tr);
            });

            // By Extension table
            const extBody = document.getElementById('byExtTableBody');
            extBody.innerHTML = '';
            Object.keys(stats.ext_counts).forEach(ext => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="py-2 px-4 border-b">.${ext}</td><td class="py-2 px-4 border-b">${stats.ext_counts[ext]}</td>`;
                extBody.appendChild(tr);
            });

            // By Type table
            const typeBody = document.getElementById('byTypeTableBody');
            typeBody.innerHTML = '';
            Object.keys(stats.type_counts).forEach(t => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="py-2 px-4 border-b">${stats.type_counts[t]}</td>`;
                typeBody.appendChild(tr);
            });

            // Score Evolution chart
            if (scoreEvolutionChart) scoreEvolutionChart.destroy();
            scoreEvolutionChart = new Chart(
                document.getElementById('scoreEvolutionChart').getContext('2d'),
                {
                    type: 'line',
                    data: {
                        labels: stats.evolution.dates,
                        datasets: [{
                            label: 'Average Score',
                            data: stats.evolution.averages,
                            fill: false,
                            borderColor: 'rgb(99, 102, 241)',
                            tension: 0.1
                        }]
                    },
                    options: { responsive: true }
                }
            );

            // Risk Distribution chart
            if (riskDistributionChart) riskDistributionChart.destroy();
            riskDistributionChart = new Chart(
                document.getElementById('riskDistributionChart').getContext('2d'),
                {
                    type: 'bar',
                    data: {
                        labels: stats.risk.dates,
                        datasets: [
                            { label: 'Safe',   data: stats.risk.safe,   backgroundColor: 'rgb(34,197,94,0.7)' },
                            { label: 'Low',    data: stats.risk.low,    backgroundColor: 'rgb(253,224,71,0.7)' },
                            { label: 'Medium', data: stats.risk.medium, backgroundColor: 'rgb(251,191,36,0.7)' },
                            { label: 'High',   data: stats.risk.high,   backgroundColor: 'rgb(239,68,68,0.7)' }
                        ]
                    },
                    options: { responsive: true, plugins: { legend: { position: 'top' } }}
                }
            );

            // By Extension pie
            if (byExtChart) byExtChart.destroy();
            byExtChart = new Chart(
                document.getElementById('byExtChart').getContext('2d'),
                {
                    type: 'pie',
                    data: {
                        labels: Object.keys(stats.ext_counts).map(e => '.' + e),
                        datasets: [{
                            data: Object.values(stats.ext_counts),
                            backgroundColor: ['#6366F1','#F59E42','#10B981','#F43F5E','#FBBF24','#3B82F6','#EAB308','#A21CAF']
                        }]
                    },
                    options: { responsive: true }
                }
            );

            // By Type doughnut
            if (byTypeChart) byTypeChart.destroy();
            byTypeChart = new Chart(
                document.getElementById('byTypeChart').getContext('2d'),
                {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(stats.type_counts),
                        datasets: [{
                            data: Object.values(stats.type_counts),
                            backgroundColor: ['#6366F1','#F59E42','#10B981','#F43F5E','#FBBF24','#3B82F6','#EAB308','#A21CAF']
                        }]
                    },
                    options: { responsive: true }
                }
            );
        }

        function getFilteredFiles() {
            const ext   = document.getElementById('filter-ext').value;
            const type  = document.getElementById('filter-type').value;
            const risk  = document.getElementById('filter-risk').value;
            const score = parseInt(document.getElementById('filter-score').value, 10);
            const date  = document.getElementById('filter-date').value;

            return statsData.files.filter(f =>
                (!ext   || f.ext   === ext) &&
                (!type  || f.type  === type) &&
                (!risk  || f.risk  === risk) &&
                (isNaN(score) || f.score >= score) &&
                (!date  || f.date  === date)
            );
        }

        function applyFilters() {
            updateAllStats(getFilteredFiles());
        }

        function resetFilters() {
            document.getElementById('filter-ext').value   = '';
            document.getElementById('filter-type').value  = '';
            document.getElementById('filter-risk').value  = '';
            document.getElementById('filter-score').value = '';
            document.getElementById('filter-date').value  = '';
            updateAllStats(statsData.files);
        }

        function populateFilterDropdowns() {
            const extSet  = new Set();
            const typeSet = new Set();
            statsData.files.forEach(f => {
                if (f.ext)  extSet.add(f.ext);
                if (f.type) typeSet.add(f.type);
            });

            const extSel  = document.getElementById('filter-ext');
            const typeSel = document.getElementById('filter-type');

            extSet.forEach(e => {
                const opt = document.createElement('option');
                opt.value = e;
                opt.textContent = '.' + e;
                extSel.appendChild(opt);
            });
            typeSet.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t;
                opt.textContent = t;
                typeSel.appendChild(opt);
            });
        }

        function showTab(tab) {
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('hidden'));
            document.getElementById(tab).classList.remove('hidden');
            updateAllStats(getFilteredFiles());
        }

        // INITIAL LOAD
        populateFilterDropdowns();
        updateAllStats(statsData.files);
        showTab('overview');
        </script>
    </div>
</body>
</html>
